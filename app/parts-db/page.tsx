"use client"

import { useState, useEffect, useMemo } from "react"
import { useRouter } from "next/navigation"
import Image from "next/image"
import { Card, CardContent } from "@/components/ui/card"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Button } from "@/components/ui/button"
import {
  fetchComponentsWithEnhancedCache as fetchComponents,
  fetchComponentsByCategoryWithEnhancedCache as fetchComponentsByCategory,
  type FirebaseComponentData,
} from "@/lib/firebase-cache-enhanced"
import PartsSearch from "@/components/parts-search"
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs"
import PartsFilter, { type FilterState } from "@/components/parts-filter"
import { generateFiltersFromComponents, applyFilters } from "@/lib/filter-utils"
import { calculatePopularityScore } from "@/lib/popularity-utils"
import {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
} from "@/components/ui/pagination"

const ITEMS_PER_PAGE = 30

export default function PartsDB() {
  const router = useRouter()
  const [selectedType, setSelectedType] = useState<string>("")
  const [components, setComponents] = useState<Record<string, FirebaseComponentData[]>>({})
  const [currentComponents, setCurrentComponents] = useState<FirebaseComponentData[]>([])
  const [loading, setLoading] = useState(true)
  const [searchQuery, setSearchQuery] = useState("")
  const [categories, setCategories] = useState<string[]>([])
  const [sortOption, setSortOption] = useState<"price-asc" | "price-desc" | "name-asc" | "name-desc" | "popularity">(
    "popularity",
  )
  const [error, setError] = useState<string | null>(null)
  const [filters, setFilters] = useState<FilterState>({})
  const [availableFilters, setAvailableFilters] = useState<any[]>([])
  const [loadingStage, setLoadingStage] = useState<string>("")
  const [performanceInfo, setPerformanceInfo] = useState<string>("")
  const [currentPage, setCurrentPage] = useState(1)

  // Î™®Îì† Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú Ìï®Ïàò (Í∞ïÌôîÎêú Ï∫êÏãú Ï†ÅÏö©)
  const loadAllComponents = async () => {
    try {
      setLoading(true)
      setError(null)
      setLoadingStage("Ï∫êÏãú ÌôïÏù∏ Ï§ë...")
      setPerformanceInfo("")

      const startTime = performance.now()

      console.log("üöÄ Í∞ïÌôîÎêú Ï∫êÏãú ÏãúÏä§ÌÖúÏúºÎ°ú fetchComponents Ìò∏Ï∂ú...")
      const data = await fetchComponents()

      const loadTime = performance.now() - startTime
      setPerformanceInfo(`Î°úÎî© ÏãúÍ∞Ñ: ${loadTime.toFixed(2)}ms`)

      console.log("üì¶ Î°úÎìúÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Îì§:", Object.keys(data))

      // Check if data is empty
      const hasData = Object.values(data).some((arr) => arr && arr.length > 0)
      if (!hasData) {
        console.error("No components data available")
        setError("Î∂ÄÌíà Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")
        setLoading(false)
        return
      }

      setComponents(data)

      // Set categories and select first one
      const availableCategories = Object.keys(data).filter((cat) => data[cat]?.length > 0)
      console.log("Available categories:", availableCategories)
      setCategories(availableCategories)

      if (availableCategories.length > 0 && !selectedType) {
        setSelectedType(availableCategories[0])
      }

      setLoading(false)
      setLoadingStage("")
    } catch (error) {
      console.error("Error loading all components:", error)
      setError("Î∂ÄÌíà Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
      setLoading(false)
      setLoadingStage("")
    }
  }

  // Fetch all component categories
  useEffect(() => {
    loadAllComponents()
  }, [])

  // Fetch components for selected category (Í∞ïÌôîÎêú Ï∫êÏãú Ï†ÅÏö©)
  useEffect(() => {
    const loadCategoryComponents = async () => {
      if (!selectedType) return

      try {
        setLoading(true)
        setError(null)
        setLoadingStage(`${selectedType} Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎî© Ï§ë...`)

        const startTime = performance.now()

        // Use cached data if available
        if (components[selectedType]) {
          console.log(`üíæ Î©îÎ™®Î¶¨ÏóêÏÑú Ï¶âÏãú Î°úÎìú: ${selectedType}`)
          setCurrentComponents(components[selectedType])
          setLoading(false)
          setLoadingStage("")
          const loadTime = performance.now() - startTime
          setPerformanceInfo(`Î©îÎ™®Î¶¨ Î°úÎî©: ${loadTime.toFixed(2)}ms`)
          return
        }

        // Otherwise fetch with enhanced cache
        console.log(`üöÄ Í∞ïÌôîÎêú Ï∫êÏãúÎ°ú ${selectedType} Î°úÎî©...`)
        const categoryComponents = await fetchComponentsByCategory(selectedType)

        const loadTime = performance.now() - startTime
        setPerformanceInfo(`${selectedType} Î°úÎî©: ${loadTime.toFixed(2)}ms`)

        console.log(`üìä ${selectedType}: ${categoryComponents.length}Í∞ú Î∂ÄÌíà Î°úÎìúÎê®`)

        if (categoryComponents.length === 0) {
          console.warn(`No components found for category ${selectedType}`)
        }

        setCurrentComponents(categoryComponents)

        // Update the components state
        setComponents((prev) => ({
          ...prev,
          [selectedType]: categoryComponents,
        }))

        setLoading(false)
        setLoadingStage("")
      } catch (error) {
        console.error(`Error loading components for category ${selectedType}:`, error)
        setError(`${selectedType} Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Î∂ÄÌíàÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.`)
        setLoading(false)
        setLoadingStage("")
      }
    }

    loadCategoryComponents()
  }, [selectedType, components])

  // Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Î°úÎìúÎê† Îïå ÌïÑÌÑ∞ ÏÉùÏÑ±
  useEffect(() => {
    if (currentComponents && currentComponents.length > 0) {
      const generatedFilters = generateFiltersFromComponents(currentComponents, selectedType)
      setAvailableFilters(generatedFilters)
    }
  }, [currentComponents, selectedType])

  // Ïπ¥ÌÖåÍ≥†Î¶¨ÎÇò ÌïÑÌÑ∞Í∞Ä Î≥ÄÍ≤ΩÎê† Îïå Ï≤´ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
  useEffect(() => {
    setCurrentPage(1)
  }, [selectedType, filters, searchQuery])

  // Filter components based on search query
  const filteredComponents = useMemo(() => {
    if (!currentComponents) return []

    let filtered = [...currentComponents]

    // ÌïÑÌÑ∞ Ï†ÅÏö©
    filtered = applyFilters(filtered, filters, selectedType)

    // Í≤ÄÏÉâ ÏøºÎ¶¨ Ï†ÅÏö©
    if (searchQuery) {
      const lowerQuery = searchQuery.toLowerCase()
      filtered = filtered.filter((component) => {
        const nameMatch = component.name?.toLowerCase().includes(lowerQuery) || false
        const descMatch = component.description?.toLowerCase().includes(lowerQuery) || false
        const specsMatch = component.specs?.toLowerCase().includes(lowerQuery) || false
        return nameMatch || descMatch || specsMatch
      })
    }

    // Ï†ïÎ†¨ Ï†ÅÏö©
    switch (sortOption) {
      case "popularity":
        filtered.sort((a, b) => calculatePopularityScore(b) - calculatePopularityScore(a))
        break
      case "price-asc":
        filtered.sort((a, b) => (a.price || 0) - (b.price || 0))
        break
      case "price-desc":
        filtered.sort((a, b) => (b.price || 0) - (a.price || 0))
        break
      case "name-asc":
        filtered.sort((a, b) => (a.name || "").localeCompare(b.name || ""))
        break
      case "name-desc":
        filtered.sort((a, b) => (b.name || "").localeCompare(a.name || ""))
        break
    }

    return filtered
  }, [currentComponents, searchQuery, sortOption, filters, selectedType])

  // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Í≥ÑÏÇ∞
  const totalPages = Math.ceil(filteredComponents.length / ITEMS_PER_PAGE)
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE
  const endIndex = startIndex + ITEMS_PER_PAGE
  const currentPageComponents = filteredComponents.slice(startIndex, endIndex)

  // Handle component selection
  const handleComponentSelect = (component: FirebaseComponentData) => {
    console.log(`Selected component: ${component.id} (${selectedType})`, component)
    // Save selected component to local storage
    try {
      let currentConfig = {}
      const configStr = localStorage.getItem("pc_config")
      if (configStr) {
        currentConfig = JSON.parse(configStr)
      }

      const updatedConfig = {
        ...currentConfig,
        [selectedType]: {
          id: component.id,
          name: component.name,
          price: component.price,
          image: component.image || "/placeholder.svg",
        },
      }

      localStorage.setItem("pc_config", JSON.stringify(updatedConfig))
    } catch (e) {
      console.error("Failed to save component to localStorage:", e)
    }

    // Navigate to select-type page
    router.push(`/select-type?type=${selectedType}&id=${component.id}`)
  }

  const handleFilterChange = (newFilters: FilterState) => {
    setFilters(newFilters)
  }

  const handleResetFilters = () => {
    setFilters({})
  }

  // Handle search
  const handleSearch = (query: string) => {
    setSearchQuery(query)
  }

  // Handle category change
  const handleCategoryChange = (category: string) => {
    setSelectedType(category)
    setSearchQuery("") // Reset search query when changing category
    setFilters({}) // Reset filters when changing category
  }

  // Handle sort option change
  const handleSortChange = (option: "price-asc" | "price-desc" | "name-asc" | "name-desc" | "popularity") => {
    setSortOption(option)
  }

  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
  const handlePageChange = (page: number) => {
    setCurrentPage(page)
    // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ïãú ÏÉÅÎã®ÏúºÎ°ú Ïä§ÌÅ¨Î°§
    window.scrollTo({ top: 0, behavior: "smooth" })
  }

  // Format category name for display
  const formatCategoryName = (category: string): string => {
    const categoryMap: Record<string, string> = {
      vga: "Í∑∏ÎûòÌîΩÏπ¥Îìú",
      cpu: "CPU",
      mb: "Î©îÏù∏Î≥¥Îìú",
      memory: "Î©îÎ™®Î¶¨",
      ssd: "SSD",
      case: "ÏºÄÏù¥Ïä§",
      cooler: "Ïø®Îü¨",
      power: "ÌååÏõåÏÑúÌîåÎùºÏù¥",
      "m.b": "Î©îÏù∏Î≥¥Îìú",
      // FirebaseÏóêÏÑú Ïã§Ï†ú ÏÇ¨Ïö©ÎêòÎäî Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÎì§
      Vga: "Í∑∏ÎûòÌîΩÏπ¥Îìú",
      Cpu: "CPU",
      "M.B": "Î©îÏù∏Î≥¥Îìú",
      Memory: "Î©îÎ™®Î¶¨",
      SSD: "SSD",
      Ssd: "SSD",
      Case: "ÏºÄÏù¥Ïä§",
      Cooler: "Ïø®Îü¨",
      Power: "ÌååÏõåÏÑúÌîåÎùºÏù¥",
    }

    return categoryMap[category] || category?.toUpperCase() || ""
  }

  if (loading && categories.length === 0) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white mx-auto mb-4"></div>
          <p className="text-xl mb-2">{loadingStage || "FirebaseÏóêÏÑú Î∂ÄÌíà Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë..."}</p>
          <p className="text-gray-400">Í∞ïÌôîÎêú Ï∫êÏãú ÏãúÏä§ÌÖú (Î©îÎ™®Î¶¨ + Ïä§ÌÜ†Î¶¨ÏßÄ)</p>
          {performanceInfo && <p className="text-blue-400 mt-2">{performanceInfo}</p>}
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-black text-white">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-3xl font-bold">Î∂ÄÌíà DB</h1>
          
        </div>

        {error && (
          <div className="bg-red-900/50 border border-red-500 text-white p-4 rounded-md mb-6">
            <p>{error}</p>
          </div>
        )}

        {/* Category tabs */}
        {categories.length > 0 ? (
          <Tabs value={selectedType} onValueChange={handleCategoryChange} className="mb-8">
            <TabsList className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">
              {categories.map((type) => (
                <TabsTrigger key={type} value={type} className="text-sm">
                  {formatCategoryName(type)}
                </TabsTrigger>
              ))}
            </TabsList>
          </Tabs>
        ) : (
          <div className="text-center py-6 mb-8 bg-gray-900 rounded-lg">
            <p className="text-gray-400">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
          </div>
        )}

        {/* Filter section - ÏÉÅÎã® Í∞ÄÎ°ú Î∞∞Ïπò */}
        {availableFilters.length > 0 && (
          <PartsFilter
            category={selectedType}
            totalCount={currentComponents.length}
            filters={availableFilters}
            selectedFilters={filters}
            onFilterChange={handleFilterChange}
            onResetFilters={handleResetFilters}
          />
        )}

        {/* Search and sort options */}
        <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
          <div className="w-full md:w-64">
            <PartsSearch onSearch={handleSearch} className="w-full" />
          </div>

          <div className="flex items-center space-x-2">
            <span className="text-sm text-gray-400">Ï†ïÎ†¨:</span>
            <select
              value={sortOption}
              onChange={(e) => handleSortChange(e.target.value as any)}
              className="bg-gray-800 text-white border border-gray-700 rounded px-2 py-1 text-sm"
            >
              <option value="popularity">Ïù∏Í∏∞Ïàú</option>
              <option value="price-asc">Í∞ÄÍ≤© ÎÇÆÏùÄÏàú</option>
              <option value="price-desc">Í∞ÄÍ≤© ÎÜíÏùÄÏàú</option>
              <option value="name-asc">Ïù¥Î¶Ñ Ïò§Î¶ÑÏ∞®Ïàú</option>
              <option value="name-desc">Ïù¥Î¶Ñ ÎÇ¥Î¶ºÏ∞®Ïàú</option>
            </select>
          </div>
        </div>

        {/* Results info with pagination */}
        <div className="flex flex-col md:flex-row justify-between items-center mb-6">
          <div className="text-gray-300 mb-4 md:mb-0">
            <p>
              Ï†ÑÏ≤¥ {filteredComponents.length}Í∞ú Ï§ë {startIndex + 1}-{Math.min(endIndex, filteredComponents.length)}Í∞ú
              ÌëúÏãú
              {searchQuery && ` ("${searchQuery}" Í≤ÄÏÉâ Í≤∞Í≥º)`}
            </p>
          </div>

          {totalPages > 1 && (
            <div className="text-sm text-gray-400">
              ÌéòÏù¥ÏßÄ {currentPage} / {totalPages}
            </div>
          )}
        </div>

        {/* Loading indicator */}
        {loading && (
          <div className="flex justify-center items-center py-12">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mx-auto mb-4"></div>
              <p className="text-gray-400">{loadingStage}</p>
            </div>
          </div>
        )}

        {/* Component list - ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎßå Î†åÎçîÎßÅ */}
        {!loading && (
          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
            {currentPageComponents.length > 0 ? (
              currentPageComponents.map((component) => (
                <Card
                  key={component.id}
                  className="bg-gray-950 border-gray-800 cursor-pointer transition-transform hover:scale-105"
                  onClick={() => handleComponentSelect(component)}
                >
                  <CardContent className="p-6">
                    <div className="w-full h-48 relative mb-4">
                      <Image
                        src={component.image || "/placeholder.svg"}
                        alt={component.name || "Î∂ÄÌíà Ïù¥ÎØ∏ÏßÄ"}
                        width={200}
                        height={200}
                        className="object-contain w-full h-full"
                        loading="lazy"
                        onError={(e) => {
                          const target = e.target as HTMLImageElement
                          target.src = "/placeholder.svg"
                        }}
                      />
                    </div>
                    <div className="mb-2">
                      <h3 className="text-xl font-semibold text-white">{component.name}</h3>
                      <p className="text-sm text-gray-400">{formatCategoryName(component.category || "")}</p>
                    </div>
                    <p className="text-2xl font-bold text-white mb-4">{component.price?.toLocaleString()}Ïõê</p>
                    <ScrollArea className="h-[150px] mb-4">
                      <p className="text-sm text-gray-200 leading-relaxed">
                        {component.specs || component.description || "ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§."}
                      </p>
                    </ScrollArea>
                  </CardContent>
                </Card>
              ))
            ) : (
              <div className="col-span-full text-center py-12">
                <p className="text-xl text-gray-400">
                  {searchQuery ? "Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§." : "Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Î∂ÄÌíàÏù¥ ÏóÜÏäµÎãàÎã§."}
                </p>
              </div>
            )}
          </div>
        )}

        {/* Pagination */}
        {!loading && totalPages > 1 && (
          <div className="flex justify-center">
            <Pagination>
              <PaginationContent>
                <PaginationItem>
                  <PaginationPrevious
                    onClick={() => currentPage > 1 && handlePageChange(currentPage - 1)}
                    className={currentPage <= 1 ? "pointer-events-none opacity-50" : "cursor-pointer"}
                  />
                </PaginationItem>

                {/* Ï≤´ ÌéòÏù¥ÏßÄ */}
                {currentPage > 3 && (
                  <>
                    <PaginationItem>
                      <PaginationLink onClick={() => handlePageChange(1)} className="cursor-pointer">
                        1
                      </PaginationLink>
                    </PaginationItem>
                    {currentPage > 4 && (
                      <PaginationItem>
                        <PaginationEllipsis />
                      </PaginationItem>
                    )}
                  </>
                )}

                {/* ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï£ºÎ≥Ä */}
                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                  const pageNum = Math.max(1, Math.min(totalPages - 4, currentPage - 2)) + i
                  if (pageNum > totalPages) return null

                  return (
                    <PaginationItem key={pageNum}>
                      <PaginationLink
                        onClick={() => handlePageChange(pageNum)}
                        isActive={pageNum === currentPage}
                        className="cursor-pointer"
                      >
                        {pageNum}
                      </PaginationLink>
                    </PaginationItem>
                  )
                })}

                {/* ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ */}
                {currentPage < totalPages - 2 && (
                  <>
                    {currentPage < totalPages - 3 && (
                      <PaginationItem>
                        <PaginationEllipsis />
                      </PaginationItem>
                    )}
                    <PaginationItem>
                      <PaginationLink onClick={() => handlePageChange(totalPages)} className="cursor-pointer">
                        {totalPages}
                      </PaginationLink>
                    </PaginationItem>
                  </>
                )}

                <PaginationItem>
                  <PaginationNext
                    onClick={() => currentPage < totalPages && handlePageChange(currentPage + 1)}
                    className={currentPage >= totalPages ? "pointer-events-none opacity-50" : "cursor-pointer"}
                  />
                </PaginationItem>
              </PaginationContent>
            </Pagination>
          </div>
        )}
      </div>
    </div>
  )
}
